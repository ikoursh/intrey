(this.webpackJsonp=this.webpackJsonp||[]).push([[8],{906:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return L}));var a,r,o,i=n(22),c=n.n(i),l=n(1),s=n.n(l),u=n(40),m=n.n(u),d=n(0),h=n.n(d),g=n(26),f=n(127),p=n(128),v=n(32),C=n(12),y=n(915),E=n(34),b=n.n(E),S=n(108),w=n(845),x=0,T=0,I={toFirestore:function(e){var t;return{msg:e.msg,timeStamp:b.a.firestore.FieldValue.serverTimestamp(),UID:null==(t=w.auth.currentUser)?void 0:t.uid}},fromFirestore:function(e,t){var n,a=e.data(t);return console.log(a),{foreign:a.UID!=(null==(n=w.auth.currentUser)?void 0:n.uid),msg:a.msg,timeStamp:a.timeStamp.toDate()}}};function O(e){var t=e.route,n=Object(d.useState)(""),a=m()(n,2),r=a[0],i=a[1],c=t.params.chat;return o(c.name),h.a.createElement(g.Layout,{level:"2",style:{flex:1}},h.a.createElement(k,{chat:c}),h.a.createElement(g.Input,{multiline:!0,onChangeText:i,value:r}),h.a.createElement(g.Button,{onPress:function(){f.a.dismiss(),w.firestore.collection("Chats").doc(c.CID).collection("Messages").withConverter(I).add({msg:r,timeStamp:new Date,foreign:!1}),i("")}},"Send"))}function k(e){var t=e.chat,n=Object(d.useState)(null),r=m()(n,2),o=r[0],i=r[1];return h.a.useEffect((function(){if(null==o)var e=w.firestore.collection("Chats").doc(t.CID).collection("Messages").orderBy("timeStamp").withConverter(I).limitToLast(20).onSnapshot((function(t){++T>50&&(console.error("max call exceeded, quitting"),e()),i(t.docs.map((function(e){return e.data({serverTimestamps:"estimate"})})))}))}),[o,i]),null==o?h.a.createElement(g.Layout,{level:"2",style:{flex:1,justifyContent:"center",alignItems:"center"}},h.a.createElement(g.Spinner,null)):h.a.createElement(h.a.Fragment,null,h.a.createElement(g.Divider,null),h.a.createElement(g.List,{data:o,renderItem:function(e){var t=e.item;return h.a.createElement(C.a,{style:a.msgContainer},h.a.createElement(C.a,{style:t.foreign?a.sentByOther:a.sentByMe},h.a.createElement(g.Text,{style:a.msgText,category:"p1"},t.msg),h.a.createElement(g.Text,{style:a.msgText,category:"s2"},t.timeStamp.toTimeString())))}}))}function L(){a=Object(g.useStyleSheet)(g.StyleService.create({newChat:{position:"absolute",right:"3%",bottom:"3%"},myChats:{flex:1},myChatsLoading:{flex:1,justifyContent:"center",alignItems:"center"},sentByMe:{backgroundColor:"color-success-default",maxWidth:"80%",borderRadius:5,alignSelf:"flex-end",margin:10,padding:7},sentByOther:{backgroundColor:"#dcdcdc",maxWidth:"80%",borderRadius:5,alignSelf:"flex-start",margin:10,padding:7},msgContainer:{width:"100%"},msgText:{color:"#000",margin:2}}));var e=Object(d.useState)("New Chat"),t=m()(e,2);r=t[0],o=t[1];var n={header:function(e){var t=e.navigation;return h.a.createElement(h.a.Fragment,null,h.a.createElement(g.TopNavigation,{title:r,alignment:"center",accessoryLeft:function(){return h.a.createElement(g.TopNavigationAction,{onPress:t.goBack,icon:function(e){return h.a.createElement(g.Icon,s()({},e,{name:"arrow-back"}))}})}}),h.a.createElement(g.Divider,null))}},i={header:function(){return h.a.createElement(g.TopNavigation,{alignment:"center",title:"My Chats"})}},c=Object(y.a)();return h.a.createElement(p.a,{behavior:"ios"===v.a.OS?"padding":"height",style:{height:"100%"}},h.a.createElement(c.Navigator,null,h.a.createElement(c.Screen,{name:"Chats",component:D,options:i}),h.a.createElement(c.Screen,{name:"New Chat",component:U,options:n}),h.a.createElement(c.Screen,{name:"Chat",component:O,options:n})))}function j(e){var t;return c.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,c.a.awrap(w.firestore.collection("Users").doc(e.id).get());case 2:if(t=n.sent.data(),x++,!t){n.next=6;break}return n.abrupt("return",{uid:e.id,name:t.userName,bio:t.bio,CID:e.data().ref});case 6:case"end":return n.stop()}}),null,null,null,Promise)}function N(e){return void 0!==e}function D(e){var t=e.navigation,n=Object(d.useState)(null),r=m()(n,2),o=r[0],i=r[1];return Object(d.useEffect)((function(){if(null==o){var e;console.log("getting chats");var t=w.firestore.collection("Users").doc(null==(e=w.auth.currentUser)?void 0:e.uid).collection("Chats").limit(10).onSnapshot((function(e){var n;return c.a.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(console.log("GOT CHATS"),x+=1,console.log(x,e.empty,e),!(x>51)){a.next=6;break}throw console.error("Failed to unsubscribe, panicking"),new Error("PANIC 1");case 6:if(!(x>50)){a.next=10;break}return t(),console.error("TO MANNY CALLS TO DB: QUITTING"),a.abrupt("return");case 10:return a.next=12,c.a.awrap(Promise.all(e.docs.map(j)));case 12:n=a.sent,i(n.filter(N));case 14:case"end":return a.stop()}}),null,null,null,Promise)}))}})),h.a.createElement(g.Layout,{level:"2",style:null==o||0==o.length?a.myChatsLoading:a.myChats},null==o?h.a.createElement(g.Spinner,null):0==(null==o?void 0:o.length)?h.a.createElement(h.a.Fragment,null,h.a.createElement(g.Text,{style:{textAlign:"center",margin:20},category:"h2"},"You don't have any chats yet"),h.a.createElement(g.Text,{category:"s1"},"Press on the + button to create some")):h.a.createElement(h.a.Fragment,null,h.a.createElement(g.Divider,null),h.a.createElement(g.List,{data:o,renderItem:function(e){var n=e.item;return h.a.createElement(g.ListItem,{title:n.name,description:n.bio,onPress:function(){t.navigate("Chat",{chat:n})}})},ItemSeparatorComponent:g.Divider})),h.a.createElement(g.Button,{size:"large",accessoryLeft:function(e){return h.a.createElement(g.Icon,s()({},e,{name:"plus-outline"}))},style:a.newChat,onPress:function(){t.navigate("New Chat")}}))}function U(e){var t=e.navigation;o("New Chat");var n=Object(d.useState)(!1),r=m()(n,2),i=r[0],l=r[1],s=Object(d.useState)(!1),u=m()(s,2),f=u[0],p=u[1];return Object(d.useEffect)((function(){f||function(){var e,n,a,r,o;c.a.async((function(i){for(;;)switch(i.prev=i.next){case 0:return p(!0),i.t0=c.a,i.t1=fetch,i.t2=S.a+"/newChat",i.t3={Accept:"application/json","Content-Type":"application/json"},i.t4=JSON,i.next=8,c.a.awrap(null==(e=w.auth.currentUser)?void 0:e.getIdToken());case 8:return i.t5=i.sent,i.t6={token:i.t5},i.t7=i.t4.stringify.call(i.t4,i.t6),i.t8={method:"POST",headers:i.t3,body:i.t7},i.t9=(0,i.t1)(i.t2,i.t8),i.next=15,i.t0.awrap.call(i.t0,i.t9);case 15:return n=i.sent,i.next=18,c.a.awrap(n.json());case 18:"pending"==(a=i.sent).link?(l(!0),r=w.firestore.collection("Users").doc(w.auth.currentUser.uid).onSnapshot((function(e){"pending"!=e.data().newChatLink&&(r(),w.firestore.collection("Users").doc(w.auth.currentUser.uid).update({newChatLink:"pending",newChatUID:"pending",newChatName:"pending"}),t.navigate("Chat",{chat:{CID:e.data().newChatLink,uid:e.data().newChatUID,bio:e.data().newChatBio,name:e.data().newChatName}}))}))):(o={CID:a.link,uid:a.uid,bio:a.bio,name:a.name},t.navigate("Chat",{chat:o}));case 20:case"end":return i.stop()}}),null,null,null,Promise)}()})),h.a.createElement(g.Layout,{level:"2",style:a.myChatsLoading},h.a.createElement(g.Spinner,null),h.a.createElement(g.Button,{disabled:!i,onPress:function(){var e;return c.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return l(!1),n.t0=fetch,n.t1=S.a+"/cancelChat",n.t2={Accept:"application/json","Content-Type":"application/json"},n.t3=JSON,n.next=7,c.a.awrap(null==(e=w.auth.currentUser)?void 0:e.getIdToken());case 7:n.t4=n.sent,n.t5={token:n.t4},n.t6=n.t3.stringify.call(n.t3,n.t5),n.t7={method:"POST",headers:n.t2,body:n.t6},(0,n.t0)(n.t1,n.t7),t.navigate("Chats");case 13:case"end":return n.stop()}}),null,null,null,Promise)}},"Cancel"))}}}]);
//# sourceMappingURL=8.038e4dc3.chunk.js.map